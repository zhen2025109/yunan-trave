<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°å°é‡Œç¨‹å¸ˆï¼šäº‘å—å¤§æŒ‘æˆ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');

        :root {
            --sky-top: #0ea5e9;
            --sky-bottom: #bae6fd;
            --grass-top: #4ade80;
            --grass-bottom: #16a34a;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            font-family: 'ZCOOL KuaiLe', cursive, sans-serif;
            background: linear-gradient(180deg, var(--sky-top) 0%, var(--sky-bottom) 45%, #ffffff 45%, #ffffff 50%, var(--grass-top) 50%, var(--grass-bottom) 100%);
            touch-action: none; 
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .cloud {
            position: absolute; background: white; border-radius: 100px; opacity: 0.6;
            filter: blur(2px); z-index: 1; pointer-events: none;
        }

        .header-bg {
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px);
            padding: 15px; padding-top: calc(15px + env(safe-area-inset-top));
            border-bottom: 4px solid rgba(255,255,255,0.5); position: relative; z-index: 100;
        }

        .route-map {
            position: relative; width: 92%; height: 180px; margin: 15px auto;
            background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);
            border-radius: 30px; border: 5px solid white; display: flex;
            align-items: center; padding: 0 40px; z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .road-line { position: absolute; height: 12px; background: rgba(0, 0, 0, 0.1); border-radius: 20px; width: calc(100% - 80px); left: 40px; }
        .road-progress { position: absolute; height: 12px; background: linear-gradient(90deg, #fcd34d, #f59e0b); border-radius: 20px; width: 0%; left: 40px; z-index: 2; transition: width 0.3s ease-out; }

        #bus {
            position: absolute; width: 100px; height: 80px; z-index: 50; top: 50%;
            transform: translate(-50%, -85%); filter: drop-shadow(0 6px 12px rgba(0,0,0,0.2));
            cursor: grab; touch-action: none;
            will-change: left;
        }

        .signboard {
            position: absolute; background: #22c55e; color: white; padding: 4px 12px;
            border-radius: 12px; font-size: 13px; bottom: 105%; left: 50%;
            transform: translateX(-50%); white-space: nowrap; box-shadow: 0 4px 0 #16a34a;
            pointer-events: none; border: 2px solid white;
        }

        .city-node { position: absolute; z-index: 20; display: flex; flex-direction: column; align-items: center; transform: translateX(-50%); pointer-events: none;}
        .city-pin { width: 12px; height: 12px; background: white; border: 3px solid #3b82f6; border-radius: 50%; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .city-node.highlight .city-pin { transform: scale(1.8); background: #fcd34d; border-color: #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.5); }
        .city-name { margin-top: 8px; font-size: 11px; font-weight: 900; color: #1e3a8a; background: rgba(255,255,255,0.9); padding: 2px 6px; border-radius: 6px; white-space: nowrap; border: 1px solid #bfdbfe;}

        .task-card {
            background: white; border-radius: 25px; padding: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.1); display: none;
            width: 90%; max-width: 350px; margin: 10px auto; z-index: 50;
            position: relative;
        }
        .task-card.active { display: block; animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .error-box {
            background: #fff7ed; border: 2px solid #fed7aa; color: #ea580c;
            padding: 10px; border-radius: 12px; font-size: 13px;
            margin-top: 12px; display: none; align-items: center; gap: 8px;
        }
        .error-box.show { display: flex; animation: shake 0.4s; }

        .btn-submit { 
            background: #f97316; color: white; padding: 14px; border-radius: 16px; 
            font-weight: bold; box-shadow: 0 4px 0 #c2410c; width: 100%;
            transition: all 0.1s;
        }
        .btn-submit:active { transform: translateY(2px); box-shadow: 0 2px 0 #c2410c; }

        .success-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; backdrop-filter: blur(6px);
        }
        .success-overlay.show { display: flex; animation: fade-in 0.3s ease; }

        #confetti-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 1100; }

        #music-toggle {
            position: fixed; bottom: 20px; right: 20px; z-index: 2000;
            background: white; width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2); cursor: pointer;
            font-size: 24px; border: 3px solid #3b82f6;
        }

        @keyframes pop-in { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-8px)} 40%{transform:translateX(8px)} 60%{transform:translateX(-8px)} 80%{transform:translateX(8px)} }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div id="music-toggle">
        <span id="music-icon">ğŸ”‡</span>
    </div>

    <div class="header-bg text-center">
        <h1 class="text-lg font-black text-blue-600 tracking-wide">ğŸšŒ å°å°é‡Œç¨‹å¸ˆï¼šäº‘å—å¤§æŒ‘æˆ˜</h1>
        <div class="flex justify-center gap-3 mt-2">
            <div class="w-3 h-3 rounded-full bg-blue-600 transition-colors duration-500" id="dot-1"></div>
            <div class="w-3 h-3 rounded-full bg-gray-200 transition-colors duration-500" id="dot-2"></div>
        </div>
    </div>

    <div class="route-map" id="map-area">
        <div class="road-line"></div>
        <div class="road-progress" id="progress-bar"></div>

        <div class="city-node" id="node-0" style="left: 40px;"><div class="city-pin"></div><div class="city-name">æ˜†æ˜(0)</div></div>
        <div class="city-node" id="node-1" style="left: 33.5%;"><div class="city-pin"></div><div class="city-name">æ¥šé›„(152)</div></div>
        <div class="city-node" id="node-2" style="left: 67%;"><div class="city-pin"></div><div class="city-name">å¤§ç†(328)</div></div>
        <div class="city-node" id="node-3" style="left: calc(100% - 40px);"><div class="city-pin"></div><div class="city-name">ä¸½æ±Ÿ(524)</div></div>

        <div id="bus" style="left: 40px;">
            <div class="signboard" id="bus-sign">é‡Œç¨‹ï¼š0 km</div>
            <svg viewBox="0 0 110 70">
                <rect x="5" y="12" width="100" height="42" rx="10" fill="#3b82f6" stroke="#1e3a8a" stroke-width="2"/>
                <rect x="15" y="18" width="22" height="16" rx="4" fill="#e0f2fe" stroke="#1e3a8a" stroke-width="1"/>
                <rect x="42" y="18" width="22" height="16" rx="4" fill="#e0f2fe" stroke="#1e3a8a" stroke-width="1"/>
                <rect x="74" y="18" width="20" height="16" rx="4" fill="#e0f2fe" stroke="#1e3a8a" stroke-width="1"/>
                <g transform="translate(18, 20)"><circle cx="8" cy="8" r="5" fill="#fca5a5"/><circle cx="6" cy="7" r="0.6" fill="#000"/><circle cx="10" cy="7" r="0.6" fill="#000"/></g>
                <g transform="translate(46, 20)"><circle cx="8" cy="8" r="5" fill="#fcd34d"/><circle cx="6" cy="8" r="0.6" fill="#000"/><circle cx="10" cy="8" r="0.6" fill="#000"/></g>
                <circle cx="28" cy="54" r="9" fill="#1e293b" /><circle cx="28" cy="54" r="4" fill="#94a3b8" />
                <circle cx="82" cy="54" r="9" fill="#1e293b" /><circle cx="82" cy="54" r="4" fill="#94a3b8" />
            </svg>
        </div>
    </div>

    <main class="flex flex-col items-center px-4 relative mt-4">
        <div class="task-card active" id="card-1">
            <h2 class="font-black text-blue-600 mb-1 text-base">ç¬¬ä¸€å…³ï¼šè·¯ç¨‹æŒ‘æˆ˜</h2>
            <p class="text-sm text-gray-600 mb-4 font-bold">ä»ã€æ¥šé›„ã€‘åˆ°ã€å¤§ç†ã€‘è¦å¼€å¤šå°‘å…¬é‡Œï¼Ÿ</p>
            <div class="input-group flex flex-col gap-3">
                <input type="number" id="input-1" inputmode="numeric" placeholder="å¡«å…¥æ•°å­—" class="bg-blue-50 border-2 border-blue-100 rounded-xl px-4 py-3 text-xl font-bold text-center focus:outline-none focus:border-blue-400">
                <button id="submit-1" class="btn-submit text-lg">ç¡® è®¤</button>
            </div>
            <div id="feedback-1" class="error-box"><span>âš ï¸</span><span>åŠ æ²¹ï¼å†ç®—ç®—çœ‹å§ (328-152)</span></div>
        </div>

        <div class="task-card" id="card-2">
            <h2 class="font-black text-blue-600 mb-1 text-base">ç¬¬äºŒå…³ï¼šç»ˆç‚¹æŒ‘æˆ˜</h2>
            <p class="text-sm text-gray-600 mb-4 font-bold">ä»ã€å¤§ç†ã€‘åˆ°ã€ä¸½æ±Ÿã€‘è¦å¼€å¤šå°‘å…¬é‡Œï¼Ÿ</p>
            <div class="input-group flex flex-col gap-3">
                <input type="number" id="input-2" inputmode="numeric" placeholder="å¡«å…¥æ•°å­—" class="bg-blue-50 border-2 border-blue-100 rounded-xl px-4 py-3 text-xl font-bold text-center focus:outline-none focus:border-blue-400">
                <button id="submit-2" class="btn-submit text-lg">ç¡® è®¤</button>
            </div>
            <div id="feedback-2" class="error-box"><span>âš ï¸</span><span>å·®ä¸€ç‚¹ç‚¹å°±å¯¹å•¦ï¼(524-328)</span></div>
        </div>
    </main>

    <div id="success-overlay" class="success-overlay">
        <div class="bg-white p-6 rounded-3xl text-center shadow-2xl mx-6 max-w-sm">
            <h1 class="text-blue-600 text-2xl font-black mb-2">ğŸ‰ å¤ªæ£’äº†ï¼</h1>
            <p id="reward-text" class="text-gray-600 mb-6 font-bold leading-relaxed"></p>
            <button id="overlay-btn" class="bg-blue-600 text-white px-8 py-3 rounded-full font-black text-lg shadow-lg active:scale-95 w-full">ç»§ç»­å‰è¿› â”</button>
        </div>
    </div>

    <script>
        // ä½¿ç”¨æ›´å…·å”¯ä¸€æ€§çš„åç§°é˜²æ­¢ identifier å†²çª
        const APP_STATE = {
            level: 1,
            totalKm: 524,
            isAudioInited: false,
            musicPlaying: false,
            isDragging: false,
            lastVisitedNode: -1,
            bgmTimeout: null,
            audioCtx: null,
            masterGain: null,
            melodyIndex: 0
        };

        const DOM_ELEMENTS = {
            bus: document.getElementById('bus'),
            mapArea: document.getElementById('map-area'),
            progressBar: document.getElementById('progress-bar'),
            busSign: document.getElementById('bus-sign'),
            musicIcon: document.getElementById('music-icon'),
            overlay: document.getElementById('success-overlay')
        };

        // ä¿®æ”¹å˜é‡åä»¥é˜²æ­¢æŠ¥é”™
        const NOTE_FREQS = {
            C4: 261.63, CS4: 277.18, D4: 293.66, DS4: 311.13, E4: 329.63, F4: 349.23, FS4: 369.99, G4: 392.00, GS4: 415.30, A4: 440.00, AS4: 466.16, B4: 493.88,
            C5: 523.25, CS5: 554.37, D5: 587.33, DS5: 622.25, E5: 659.25, F5: 698.46, FS5: 739.99, G5: 783.99, GS5: 830.61, A5: 880.00, AS5: 932.33, B5: 987.77,
            G4_LOW: 392.00, G5_HI: 783.99, C6: 1046.50
        };

        const MARIO_MELODY = [
            // å¼€åœº
            { f: NOTE_FREQS.E5, d: 150 }, { f: 0, d: 50 }, { f: NOTE_FREQS.E5, d: 150 }, { f: 0, d: 150 }, { f: NOTE_FREQS.E5, d: 150 }, { f: 0, d: 150 }, 
            { f: NOTE_FREQS.C5, d: 150 }, { f: NOTE_FREQS.E5, d: 150 }, { f: 0, d: 150 }, { f: NOTE_FREQS.G5, d: 150 }, { f: 0, d: 450 }, { f: NOTE_FREQS.G4, d: 150 }, { f: 0, d: 450 },
            // Aæ®µ
            { f: NOTE_FREQS.C5, d: 150 }, { f: 0, d: 300 }, { f: NOTE_FREQS.G4, d: 150 }, { f: 0, d: 300 }, { f: NOTE_FREQS.E4, d: 150 }, { f: 0, d: 300 }, 
            { f: NOTE_FREQS.A4, d: 150 }, { f: 0, d: 150 }, { f: NOTE_FREQS.B4, d: 150 }, { f: 0, d: 150 }, { f: NOTE_FREQS.AS4, d: 150 }, { f: NOTE_FREQS.A4, d: 150 }, { f: 0, d: 150 },
            { f: NOTE_FREQS.G4, d: 100 }, { f: NOTE_FREQS.E5, d: 100 }, { f: NOTE_FREQS.G5, d: 100 }, { f: NOTE_FREQS.A5, d: 150 }, { f: 0, d: 150 }, { f: NOTE_FREQS.F5, d: 150 }, { f: NOTE_FREQS.G5, d: 150 }, { f: 0, d: 150 }, { f: NOTE_FREQS.E5, d: 150 }, { f: 0, d: 150 }, { f: NOTE_FREQS.C5, d: 150 }, { f: NOTE_FREQS.D5, d: 150 }, { f: NOTE_FREQS.B4, d: 150 }, { f: 0, d: 300 }
        ];

        function initAudioEngine() {
            if (APP_STATE.isAudioInited) return;
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                APP_STATE.audioCtx = new AudioContext();
                APP_STATE.masterGain = APP_STATE.audioCtx.createGain();
                APP_STATE.masterGain.connect(APP_STATE.audioCtx.destination);
                APP_STATE.masterGain.gain.value = 0.15;
                APP_STATE.isAudioInited = true;
                APP_STATE.musicPlaying = true;
                DOM_ELEMENTS.musicIcon.innerText = 'ğŸµ';
                runBGM();
            } catch (e) { console.error("éŸ³é¢‘å¯åŠ¨å¤±è´¥", e); }
        }

        function playSynthTone(freq, duration, volume = 0.1) {
            if (!APP_STATE.isAudioInited || APP_STATE.audioCtx.state === 'suspended' || freq === 0) return;
            const osc = APP_STATE.audioCtx.createOscillator();
            const g = APP_STATE.audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(freq, APP_STATE.audioCtx.currentTime);
            
            g.gain.setValueAtTime(volume, APP_STATE.audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, APP_STATE.audioCtx.currentTime + (duration/1000));
            
            osc.connect(g);
            g.connect(APP_STATE.masterGain);
            osc.start();
            osc.stop(APP_STATE.audioCtx.currentTime + (duration/1000));
        }

        function playCoinEffect() {
            playSynthTone(987, 100, 0.2);
            setTimeout(() => playSynthTone(1318, 300, 0.2), 80);
        }

        function runBGM() {
            if (APP_STATE.bgmTimeout) clearTimeout(APP_STATE.bgmTimeout);
            
            const next = () => {
                if (APP_STATE.musicPlaying && APP_STATE.isAudioInited) {
                    const note = MARIO_MELODY[APP_STATE.melodyIndex];
                    if (note.f > 0) {
                        playSynthTone(note.f, note.d, 0.08);
                    }
                    APP_STATE.melodyIndex = (APP_STATE.melodyIndex + 1) % MARIO_MELODY.length;
                    APP_STATE.bgmTimeout = setTimeout(next, note.d);
                } else {
                    APP_STATE.bgmTimeout = setTimeout(next, 500);
                }
            };
            next();
        }

        function getLayout() {
            const rect = DOM_ELEMENTS.mapArea.getBoundingClientRect();
            const padding = 40;
            const roadWidth = rect.width - (padding * 2);
            return { rect, padding, roadWidth };
        }

        function refreshUI(clientX) {
            const { rect, padding, roadWidth } = getLayout();
            let x = clientX - rect.left;
            x = Math.max(padding, Math.min(x, rect.width - padding));

            DOM_ELEMENTS.bus.style.left = x + 'px';
            const progress = (x - padding) / roadWidth;
            DOM_ELEMENTS.progressBar.style.width = (progress * 100) + '%';
            DOM_ELEMENTS.busSign.innerText = `é‡Œç¨‹ï¼š${Math.round(progress * APP_STATE.totalKm)} km`;

            const nodes = [0, 0.335, 0.67, 1.0];
            let activeId = -1;
            nodes.forEach((pos, i) => {
                const nodeX = padding + pos * roadWidth;
                const dist = Math.abs(x - nodeX);
                const el = document.getElementById(`node-${i}`);
                if (dist < 15) {
                    el.classList.add('highlight');
                    activeId = i;
                } else {
                    el.classList.remove('highlight');
                }
            });

            if (activeId !== -1 && activeId !== APP_STATE.lastVisitedNode) {
                playCoinEffect();
                APP_STATE.lastVisitedNode = activeId;
            } else if (activeId === -1) {
                APP_STATE.lastVisitedNode = -1;
            }
        }

        const onStart = (e) => {
            initAudioEngine();
            if (APP_STATE.audioCtx.state === 'suspended') APP_STATE.audioCtx.resume();
            APP_STATE.isDragging = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            refreshUI(clientX);
        };

        const onMove = (e) => {
            if (!APP_STATE.isDragging) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            requestAnimationFrame(() => refreshUI(clientX));
            if (e.cancelable) e.preventDefault();
        };

        DOM_ELEMENTS.bus.addEventListener('mousedown', onStart);
        DOM_ELEMENTS.bus.addEventListener('touchstart', onStart, { passive: false });
        window.addEventListener('mousemove', onMove);
        window.addEventListener('touchmove', onMove, { passive: false });
        window.addEventListener('mouseup', () => APP_STATE.isDragging = false);
        window.addEventListener('touchend', () => APP_STATE.isDragging = false);

        document.getElementById('music-toggle').onclick = (e) => {
            e.stopPropagation();
            initAudioEngine();
            APP_STATE.musicPlaying = !APP_STATE.musicPlaying;
            DOM_ELEMENTS.musicIcon.innerText = APP_STATE.musicPlaying ? 'ğŸµ' : 'ğŸ”‡';
        };

        function validate(lvl, correct) {
            initAudioEngine();
            const input = document.getElementById(`input-${lvl}`);
            const feedback = document.getElementById(`feedback-${lvl}`);
            const val = parseInt(input.value);

            if (val === correct) {
                feedback.classList.remove('show');
                playCoinEffect();
                if (lvl === 1) {
                    showDialog("ç¬¬ä¸€é˜¶æ®µå®Œæˆï¼å·´å£«æ­£åœ¨å‰å¾€å¤§ç†ï¼");
                    autoDrive(0.67);
                } else {
                    showDialog("ç»ˆç‚¹æŠµè¾¾ï¼ä½ å·²ç»å®Œæˆå…¨éƒ¨é‡Œç¨‹æŒ‘æˆ˜ï¼");
                    autoDrive(1.0);
                }
            } else {
                feedback.classList.add('show');
            }
        }

        function autoDrive(ratio) {
            const { padding, roadWidth } = getLayout();
            const targetX = padding + (roadWidth * ratio) + DOM_ELEMENTS.mapArea.getBoundingClientRect().left;
            DOM_ELEMENTS.bus.style.transition = 'left 1s cubic-bezier(0.25, 1, 0.5, 1)';
            DOM_ELEMENTS.progressBar.style.transition = 'width 1s cubic-bezier(0.25, 1, 0.5, 1)';
            refreshUI(targetX);
            setTimeout(() => {
                DOM_ELEMENTS.bus.style.transition = '';
                DOM_ELEMENTS.progressBar.style.transition = '';
            }, 1000);
        }

        function showDialog(msg) {
            document.getElementById('reward-text').innerText = msg;
            DOM_ELEMENTS.overlay.classList.add('show');
            launchConfetti();
        }

        function reset() {
            APP_STATE.level = 1;
            APP_STATE.lastVisitedNode = -1;
            document.getElementById('dot-1').classList.replace('bg-green-500', 'bg-blue-600');
            document.getElementById('dot-2').classList.replace('bg-blue-600', 'bg-gray-200');
            document.getElementById('card-1').classList.add('active');
            document.getElementById('card-2').classList.remove('active');
            document.getElementById('input-1').value = '';
            document.getElementById('input-2').value = '';
            autoDrive(0);
            DOM_ELEMENTS.overlay.classList.remove('show');
        }

        document.getElementById('submit-1').onclick = () => validate(1, 176);
        document.getElementById('submit-2').onclick = () => validate(2, 196);
        document.getElementById('overlay-btn').onclick = () => {
            if (APP_STATE.level === 1) {
                APP_STATE.level = 2;
                document.getElementById('dot-1').classList.replace('bg-blue-600', 'bg-green-500');
                document.getElementById('dot-2').classList.replace('bg-gray-200', 'bg-blue-600');
                document.getElementById('card-1').classList.remove('active');
                document.getElementById('card-2').classList.add('active');
                DOM_ELEMENTS.overlay.classList.remove('show');
            } else {
                reset();
            }
        };

        function launchConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            let parts = Array.from({length: 60}, () => ({
                x: canvas.width/2, y: canvas.height/2,
                vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20-5,
                s: Math.random()*10+5, c: `hsl(${Math.random()*360}, 80%, 60%)`,
                l: 1
            }));
            const loop = () => {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                parts.forEach((p, i) => {
                    p.vy += 0.3; p.x += p.vx; p.y += p.vy; p.l -= 0.015;
                    ctx.fillStyle = p.c; ctx.globalAlpha = p.l;
                    ctx.fillRect(p.x, p.y, p.s, p.s);
                    if(p.l <= 0) parts.splice(i, 1);
                });
                if(parts.length > 0) requestAnimationFrame(loop);
            };
            loop();
        }
    </script>
</body>
</html>
